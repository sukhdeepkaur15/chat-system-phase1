<div class="dashboard">
  <!-- WELCOME PANEL (now also contains the groups list) -->
  <div class="hero">
    <h2 data-cy="welcome" style="margin:0 0 4px;">Welcome, {{ greetingTitle }} ðŸŽŠ</h2>
    <p style="margin:0 0 14px;">Your Role: {{ roleDisplay }}</p>

    <!-- Profile Avatar Upload -->
    <div style="margin-top:10px">
      <label style="font-weight:600; display:block; margin-bottom:6px;">Update Avatar</label>
      <input type="file" accept="image/*" (change)="uploadAvatar($event)">
    </div>

    <!-- Super / Group Admin: create group -->
    <div *ngIf="role.includes('super') || role.includes('groupAdmin')" class="row">
      <input #newGroupName class="input-framed" placeholder="New Group Name" data-cy="new-group-name" />
      <button class="btn-blue" data-cy="add-group"
              (click)="createGroup(newGroupName.value); newGroupName.value=''">
        Add Group
      </button>
    </div>

    <!-- GROUPS LIST lives inside the same hero card -->
    <div class="groups-in-hero">
      <div *ngFor="let group of groups; trackBy: trackById" class="group-item">
        <h3 (click)="selectGroup(group)" style="cursor:pointer;margin:0 0 8px;">{{ group.name }}</h3>

        <!-- Normal User ONLY: request or pending -->
        <div *ngIf="!isSuper">
          <div *ngIf="!isMember(group) && !hasRequested(group)">
            <button class="btn-blue" (click)="requestToJoin(group)">Request to Join</button>
          </div>
          <div *ngIf="hasRequested(group)">
            <span>Request pending...</span>
          </div>
        </div>

        <!-- Approvals -->
        <div *ngIf="canModerate(group) && ((group.joinRequests?.length || 0) > 0)">
          <h4>Pending Join Requests:</h4>
          <div *ngFor="let uid of (group.joinRequests || [])" class="row">
            <span>{{ getUserById(uid)?.username || uid }}</span>
            <button class="btn-green" (click)="approveJoinRequest(group, uid)">Approve</button>
            <button class="btn-red" (click)="rejectJoinRequest(group, uid)">Reject</button>
          </div>
        </div>

        <!-- Selected group panel -->
        <div *ngIf="selectedGroup?.id === group.id" class="channels-panel panel-framed" style="margin-top:10px;">
          <ul>
            <li *ngFor="let ch of visibleChannels; trackBy: trackById"
                (click)="selectChannel(ch)" style="cursor:pointer">
              {{ ch.name }}
              <button *ngIf="canModerate(group)"
                      class="btn-orange"
                      (click)="removeChannel(group, ch.id); $event.stopPropagation()">
                Remove
              </button>
            </li>
          </ul>

          <p *ngIf="visibleChannels.length === 0" style="margin:6px 0 10px;">
            You don't have access to any channels in this group yet.
          </p>

          <!-- ONE ROW: Add channel (if GA/Super) + Leave (always if member) + Delete (if GA/Super) -->
          <div class="action-row compact-actions">
            <ng-container *ngIf="canModerate(group)">
              <input #newChannelName class="input-framed" placeholder="New Channel Name" data-cy="new-channel-name" />
              <button class="btn-green" data-cy="add-channel"
                      (click)="addChannelToGroup(group, newChannelName.value); newChannelName.value=''">
                Add Channel
              </button>
            </ng-container>

            <div class="right-actions">
              <button class="btn-blue" *ngIf="isMember(group)" (click)="leaveGroup(group)">Leave Group</button>
              <button class="btn-red"  *ngIf="canModerate(group)" (click)="deleteGroup(group)">Delete Group</button>
            </div>
          </div>

          <!-- CHANNEL MEMBERS -->
          <div class="panel-framed" *ngIf="selectedChannel && canModerate(group)">
            <h4>Channel Members: {{ selectedChannel.name }}</h4>
            <div *ngIf="channelMemberIds(selectedChannel).length === 0">No channel members yet.</div>
            <ul>
              <li *ngFor="let uid of channelMemberIds(selectedChannel)">
                {{ getUserById(uid)?.username || uid }}
              </li>
            </ul>
          </div>

          <!-- BAN AT CHANNEL -->
          <div class="panel-framed" *ngIf="canModerate(group)">
            <div class="ban-title">Ban at Channel</div>
            <div class="row">
              <input #banName class="input-framed" placeholder="Username to ban" />
              <button class="btn-red"
                      (click)="banUser(selectedGroup, selectedChannel, banName.value); banName.value=''"
                      [disabled]="!selectedChannel || !banName.value">
                Ban
              </button>
            </div>

            <ul>
              <li *ngFor="let uname of (selectedChannel?.bannedUsernames || [])">
                {{ uname }}
                <button class="btn-green"
                        (click)="unbanUser(selectedGroup, selectedChannel, uname)"
                        [disabled]="!selectedChannel">
                  Unban
                </button>
              </li>
            </ul>

            <small *ngIf="!selectedChannel" class="small">
              Tip: click a channel name above to select it, then use Ban.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Box -->
<div *ngIf="selectedChannel" class="chat-card" style="max-width:900px;margin:12px auto 0;">
  <h4>Channel: {{ selectedChannel.name }}</h4>

  <div *ngIf="isBannedHere" class="ban-banner">
    You are banned from this channel. You can read past messages but cannot send new ones.
  </div>
  
    <!-- show current user's avatar if set -->
    <img *ngIf="currentUser?.avatarUrl"
         [src]="currentUser.avatarUrl"
         alt="My avatar"
         style="width:40px;height:40px;border-radius:50%;margin-right:8px;" />

    <!-- Messages with avatars + images -->
    <div class="messages panel-framed" data-cy="messages">
      <div *ngFor="let msg of messages" class="chat-message">
        <img *ngIf="msg.avatarUrl" [src]="msg.avatarUrl" class="avatar" />
        <strong>{{ msg.username }}:</strong>
        <span *ngIf="!msg.imageUrl">{{ msg.content }}</span>
        <img *ngIf="msg.imageUrl" [src]="msg.imageUrl" class="chat-image" />
      </div>
    </div>

    <!-- ONE input row only (stable hooks) -->
  <div class="row">
    <input
      [(ngModel)]="newMessage"
      class="input-framed"
      placeholder="Type message..."
      [disabled]="isBannedHere"
      data-cy="message-input"
    />
    <button
      class="btn-blue"
      (click)="sendMessage()"
      [disabled]="isBannedHere"
      data-cy="send-btn"
    >
      Send
    </button>

    <!-- Chat image upload -->
    <input
      type="file"
      accept="image/*"
      (change)="sendImage($event)"
      [disabled]="isBannedHere"
      data-cy="chat-upload"
    />
  </div>
</div>

    <!-- Video controls -->
    <div class="controls" style="display:flex; gap:8px; align-items:center; margin-top:12px;">
      <button class="btn-green" (click)="startVideoChat()" [disabled]="!joined || startingVideo">Start Video Chat</button>
      <button class="btn-orange" (click)="endVideoChat()" [disabled]="!inCall">End Call</button>

      <input class="input" placeholder="Remote Peer ID" [(ngModel)]="remotePeerId" />
      <button class="btn-blue" (click)="callRemote()" [disabled]="!localStream || !remotePeerId">Call</button>

      <span style="margin-left:auto">Your ID: <code>{{ myPeerId || 'â€”' }}</code></span>
      <button class="btn-blue" (click)="copyMyId()" [disabled]="!myPeerId">Copy</button>
      <button class="btn-grey" (click)="newPeerId()">New ID</button>
    </div>

    <div class="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
      <div class="panel-framed">
        <strong>Me</strong>
        <video #localVideo autoplay playsinline muted style="width:100%; border-radius:8px;"></video>
      </div>
      <div class="panel-framed">
        <strong>Remote</strong>
        <video #remoteVideo autoplay playsinline style="width:100%; border-radius:8px;"></video>
      </div>
    </div>
  </div>

  <!-- SUPER ADMIN PANEL -->
  <div *ngIf="role.includes('super')" class="super-admin-panel">
    <h2>Super Admin Panel</h2>

    <!-- Create User -->
    <h3>Create New User</h3>
    <div class="create-user-panel">
      <div class="row">
        <input [(ngModel)]="newUsername" class="input-framed-lg" placeholder="Username" />
        <input [(ngModel)]="newEmail" class="input-framed-lg" placeholder="Email" />
        <select [(ngModel)]="newRole" class="input-framed-lg">
          <option value="user">User</option>
          <option value="groupAdmin">Group Admin</option>
          <option value="super">Super Admin</option>
        </select>
        <button class="btn-blue" (click)="createUser()">Create User</button>
      </div>
    </div>

    <!-- Manage Users -->
    <h3>Manage Users</h3>
    <table cellpadding="5" style="width:100%;">
      <tr class="table-head">
        <th>Username</th>
        <th>Email</th>
        <th>Roles</th>
        <th>Actions</th>
      </tr>
      <tr *ngFor="let u of allUsers">
        <td>{{ u.username }}</td>
        <td>{{ u.email }}</td>
        <td>{{ u.roles.join(', ') }}</td>
        <td>
          <button class="btn-green" (click)="promoteUser(u, 'groupAdmin')">Promote to Group Admin</button>
          <button class="btn-blue"  (click)="promoteUser(u, 'super')">Promote to Super</button>
          <button class="btn-red"   (click)="deleteUser(u)">Delete</button>
        </td>
      </tr>
    </table>

    <!-- Moderation Reports -->
    <h3 style="margin-top:16px;">Moderation Reports</h3>
    <div *ngIf="!reports?.length" style="opacity:.8">No pending reports.</div>

    <ul *ngIf="reports?.length">
      <li *ngFor="let r of reports" style="margin-bottom:10px;">
        <div>
          <strong>{{ r.reason || 'Ban issued' }}</strong>
          â€” Target: <code>{{ r.targetUsername || r.targetUserId || 'â€”' }}</code>
          â€” Group: <code>{{ r.groupName || r.groupId }}</code>
          â€” Channel: <code>{{ r.channelName || r.channelId }}</code>
          â€” By: <code>{{ r.actorUsername || r.actorUserId || 'â€”' }}</code>
          â€” <small>{{ r.createdAt | date:'short' }}</small>
          â€” <em>Status: {{ r.status || 'open' }}</em>
        </div>

        <div style="margin-top:6px;">
          <button class="btn-green"
                  *ngIf="(r.status || 'open') === 'open'"
                  (click)="resolveReport(r)">
            Mark Resolved
          </button>
          <span *ngIf="r.status === 'resolved'" style="color:#2e7d32;">Resolved</span>
        </div>
      </li>
    </ul>
  </div>
 
  <div class="logout-center" style="display:flex; justify-content:center; margin:16px 0 8px;">
    <button class="btn-red btn-wide" (click)="logout()" data-cy="logout">Logout</button>
  </div>

