<div class="dashboard">
  <!-- WELCOME PANEL (now also contains the groups list) -->
  <div class="hero">
    <h2 style="margin:0 0 4px;">Welcome, {{ greetingTitle }} ðŸŽŠ</h2>
    <p style="margin:0 0 14px;">Your Role: {{ roleDisplay }}</p>

    <!-- Profile Avatar Upload -->
    <div class="row" style="margin-bottom:10px;">
      <input type="file" (change)="uploadAvatar($event)" />
    </div>

    <!-- Super / Group Admin: create group -->
    <div *ngIf="role.includes('super') || role.includes('groupAdmin')" class="row">
      <input #newGroupName class="input-framed" placeholder="New Group Name" />
      <button class="btn-blue" (click)="createGroup(newGroupName.value); newGroupName.value=''">
        Add Group
      </button>
    </div>

    <!-- GROUPS LIST lives inside the same hero card -->
    <div class="groups-in-hero">
      <div *ngFor="let group of groups; trackBy: trackById" class="group-item">
        <h3 (click)="selectGroup(group)" style="cursor:pointer;margin:0 0 8px;">{{ group.name }}</h3>

        <!-- Normal User ONLY: request or pending -->
        <div *ngIf="!isSuper">
          <div *ngIf="!isMember(group) && !hasRequested(group)">
            <button class="btn-blue" (click)="requestToJoin(group)">Request to Join</button>
          </div>
          <div *ngIf="hasRequested(group)">
            <span>Request pending...</span>
          </div>
        </div>

        <!-- Approvals -->
        <div *ngIf="canModerate(group) && ((group.joinRequests?.length || 0) > 0)">
          <h4>Pending Join Requests:</h4>
          <div *ngFor="let uid of (group.joinRequests || [])" class="row">
            <span>{{ getUserById(uid)?.username || uid }}</span>
            <button class="btn-green" (click)="approveJoinRequest(group, uid)">Approve</button>
            <button class="btn-red" (click)="rejectJoinRequest(group, uid)">Reject</button>
          </div>
        </div>

        <!-- Selected group panel -->
        <div *ngIf="selectedGroup?.id === group.id" class="channels-panel panel-framed" style="margin-top:10px;">
          <ul>
            <li
              *ngFor="let ch of visibleChannels; trackBy: trackById"
              (click)="selectChannel(ch)"
              style="cursor:pointer"
            >
              {{ ch.name }}
              <button
                *ngIf="canModerate(group)"
                class="btn-orange"
                (click)="removeChannel(group, ch.id); $event.stopPropagation()"
              >
                Remove
              </button>
            </li>
          </ul>

          <p *ngIf="visibleChannels.length === 0" style="margin:6px 0 10px;">
            You don't have access to any channels in this group yet.
          </p>

          <!-- ONE ROW: Add channel (if GA/Super) + Leave (always if member) + Delete (if GA/Super) -->
          <div class="action-row compact-actions">
            <ng-container *ngIf="canModerate(group)">
              <input #newChannelName class="input-framed" placeholder="New Channel Name" />
              <button class="btn-green"
                      (click)="addChannelToGroup(group, newChannelName.value); newChannelName.value=''">
                Add Channel
              </button>
            </ng-container>

            <div class="right-actions">
              <button class="btn-blue" *ngIf="isMember(group)" (click)="leaveGroup(group)">Leave Group</button>
              <button class="btn-red"  *ngIf="canModerate(group)" (click)="deleteGroup(group)">Delete Group</button>
            </div>
          </div>

          <!-- CHANNEL MEMBERS -->
          <div class="panel-framed" *ngIf="selectedChannel && canModerate(group)">
            <h4>Channel Members: {{ selectedChannel.name }}</h4>
            <div *ngIf="channelMemberIds(selectedChannel).length === 0">No channel members yet.</div>
            <ul>
              <li *ngFor="let uid of channelMemberIds(selectedChannel)">
                {{ getUserById(uid)?.username || uid }}
              </li>
            </ul>
          </div>

          <!-- BAN AT CHANNEL -->
          <div class="panel-framed" *ngIf="canModerate(group)">
            <div class="ban-title">Ban at Channel</div>
            <div class="row">
              <input #banName class="input-framed" placeholder="Username to ban" />
              <button
                class="btn-red"
                (click)="banUser(selectedGroup, selectedChannel, banName.value); banName.value=''"
                [disabled]="!selectedChannel || !banName.value"
              >
                Ban
              </button>
            </div>

            <ul>
              <li *ngFor="let uname of (selectedChannel?.bannedUsernames || [])">
                {{ uname }}
                <button
                  class="btn-green"
                  (click)="unbanUser(selectedGroup, selectedChannel, uname)"
                  [disabled]="!selectedChannel"
                >
                  Unban
                </button>
              </li>
            </ul>

            <small *ngIf="!selectedChannel" class="small">
              Tip: click a channel name above to select it, then use Ban.
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Box -->
  <div *ngIf="selectedChannel" class="chat-card" style="max-width:900px;margin:12px auto 0;">
    <h4>Channel: {{ selectedChannel.name }}</h4>

    <div *ngIf="isBannedHere" class="ban-banner">
      You are banned from this channel. You can read past messages but cannot send new ones.
    </div>

    <!-- Messages with avatars + images -->
    <div class="messages panel-framed">
      <div *ngFor="let msg of messages" class="chat-message">
        <img *ngIf="msg.username" [src]="msg.avatarUrl" class="avatar" />
        <strong>{{ msg.username }}:</strong>
        <span *ngIf="!msg.imageUrl">{{ msg.content }}</span>
        <img *ngIf="msg.imageUrl" [src]="msg.imageUrl" class="chat-image" />
      </div>
    </div>

    <!-- Message input + upload -->
    <div class="row">
      <input [(ngModel)]="newMessage" class="input-framed" placeholder="Type message..." [disabled]="isBannedHere" />
      <button class="btn-blue" (click)="sendMessage()" [disabled]="isBannedHere">Send</button>
      <!-- âœ… Image Upload Button -->
      <input type="file" accept="image/*" (change)="sendImage($event)" />
     </div>
    </div>

    <!-- Video Chat -->
    <div class="panel-framed" style="margin-top:10px;">
      <button class="btn-green" (click)="startVideoChat()">Start Video Chat</button>
      <div id="video-container"></div>
    </div>
  </div>

  <!-- SUPER ADMIN PANEL -->
  <div *ngIf="role.includes('super')" class="super-admin-panel">
    <h2>Super Admin Panel</h2>
    ...
  </div>

  <div class="logout-center">
    <button class="btn-red btn-wide" (click)="logout()">Logout</button>
  </div>


